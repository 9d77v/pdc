version: '3.6'

services:
  minio:
    image: 9d77v/minio:arm64.2020-04-12
    restart: always
    volumes:
      - ./minio/data:/data
    ports:
      - 9000:9000
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123 
    command: minio server /data
    container_name: minio
  clickhouse-server:
    image: 9d77v/clickhouse-server:arm64.2020-09-05
    restart: always
    volumes: 
      - ./clickhouse/data:/var/lib/clickhouse
      # - ./clickhouse/config.xml:/ClickHouse/config.xml
      # - ./clickhouse/users.mxl:/ClickHouse/users.xml
    ports:
      - 9001:9000
    container_name: clickhouse-server
  nats-streaming:
    image: nats-streaming:0.18.0-alpine3.12
    restart: always
    ports:
      - 4222:4222
      - 8222:8222
    container_name: nats-streaming
  elasticsearch:
    image: 9d77v/elasticsearch:7.8.1
    restart: always
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms1024m -Xmx1024m
    ports:
      - 9200:9200
      - 9300:9300
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./elasticsearch/analysis-ik/custom:/usr/share/elasticsearch/config/analysis-ik/custom
      - ./elasticsearch/analysis:/usr/share/elasticsearch/config/analysis
    container_name: elasticsearch
  db:
    image: postgres:12.1-alpine
    restart: always
    user: root
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
      POSTGRES_DB: postgres
    ports:
      - 5432:5432
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    container_name: db
  redis:
    image: redis:6.0.5-alpine
    restart: always
    ports:
      - 6379:6379
    command: redis-server --appendonly yes
    volumes:
        - ./redis/data:/data
    container_name: redis
  pdc:
    image: 9d77v/pdc:2020-11-14_cc12070
    restart: always
    ports: 
      - 8080:8080
    env_file:
      - pdc.env
    container_name: pdc
  # pdc-device-esp8266-sht3x:
  #   image: 9d77v/pdc-device-esp8266-sht3x:2020-10-15_a55bff4
  #   restart: always
  #   env_file:
  #     - pdc.env
  #   container_name: pdc-device-esp8266-sht3x
  # pdc-device-raspi:
  #   image: 9d77v/pdc-device-raspi:2020-10-15_a55bff4
  #   restart: always
  #   env_file:
  #     - pdc.env
  #   devices:
  #     - /dev/i2c-0
  #     - /dev/i2c-1  
  #   container_name: pdc-device-raspi
  caddy:
    image: 9d77v/caddy:2.1.1-alpine
    restart: always
    ports:
      - 80:80
      - 443:443
    user: root
    environment:
      - TZ=Asia/Shanghai
      - ALICLOUD_ACCESS_KEY=
      - ALICLOUD_SECRET_KEY=
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy/config:/config/caddy
      - ./caddy/data:/data/caddy
    container_name: caddy
